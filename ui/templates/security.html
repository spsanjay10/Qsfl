{% extends "base.html" %}

{% block title %}Security - QSFL-CAAD{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-shield-alt me-2"></i>
        Security Monitoring
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#attackModal">
                <i class="fas fa-bug"></i> Simulate Attack
            </button>
            <button type="button" class="btn btn-sm btn-outline-warning" id="generateReportBtn">
                <i class="fas fa-file-alt"></i> Generate Report
            </button>
        </div>
    </div>
</div>

<!-- Security Metrics -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card text-white bg-success">
            <div class="card-body text-center">
                <h3 id="detectionRate">0%</h3>
                <p class="card-text">Detection Rate</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card text-white bg-warning">
            <div class="card-body text-center">
                <h3 id="falsePositiveRate">0%</h3>
                <p class="card-text">False Positive Rate</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card text-white bg-danger">
            <div class="card-body text-center">
                <h3 id="activeThreats">0</h3>
                <p class="card-text">Active Threats</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card text-white bg-info">
            <div class="card-body text-center">
                <h3 id="securityScore">100</h3>
                <p class="card-text">Security Score</p>
            </div>
        </div>
    </div>
</div>

<!-- Threat Detection Timeline -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    Threat Detection Timeline
                </h5>
            </div>
            <div class="card-body">
                <div id="threatTimelineChart" style="height: 400px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Security Events and Alerts -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Security Events
                </h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary active" data-filter="all">All</button>
                    <button class="btn btn-outline-danger" data-filter="high">High</button>
                    <button class="btn btn-outline-warning" data-filter="medium">Medium</button>
                    <button class="btn btn-outline-info" data-filter="low">Low</button>
                </div>
            </div>
            <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                <div id="securityEventsList">
                    <!-- Security events will be populated here -->
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bell me-2"></i>
                    Active Alerts
                </h5>
            </div>
            <div class="card-body">
                <div id="activeAlerts">
                    <!-- Active alerts will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Attack Patterns Analysis -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Attack Types Distribution
                </h5>
            </div>
            <div class="card-body">
                <div id="attackTypesChart" style="height: 300px;"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-thermometer-half me-2"></i>
                    Threat Level Heatmap
                </h5>
            </div>
            <div class="card-body">
                <div id="threatHeatmap" style="height: 300px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Quantum Security Status -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-atom me-2"></i>
                    Quantum Security Status
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="mb-3">
                                <i class="fas fa-key fa-3x text-primary"></i>
                            </div>
                            <h6>CRYSTALS-Kyber</h6>
                            <span class="badge bg-success">Active</span>
                            <p class="text-muted mt-2">Key Exchange Protocol</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="mb-3">
                                <i class="fas fa-signature fa-3x text-success"></i>
                            </div>
                            <h6>CRYSTALS-Dilithium</h6>
                            <span class="badge bg-success">Active</span>
                            <p class="text-muted mt-2">Digital Signatures</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="mb-3">
                                <i class="fas fa-shield-alt fa-3x text-info"></i>
                            </div>
                            <h6>Security Level</h6>
                            <span class="badge bg-info">128-bit</span>
                            <p class="text-muted mt-2">Post-Quantum Security</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Attack Simulation Modal -->
<div class="modal fade" id="attackModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-bug me-2"></i>
                    Attack Simulation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="attackForm">
                    <div class="mb-3">
                        <label class="form-label">Attack Type</label>
                        <select class="form-select" id="attackType">
                            <option value="gradient_poisoning">Gradient Poisoning</option>
                            <option value="label_flipping">Label Flipping</option>
                            <option value="backdoor">Backdoor Attack</option>
                            <option value="model_replacement">Model Replacement</option>
                            <option value="byzantine">Byzantine Attack</option>
                        </select>
                        <div class="form-text">Select the type of attack to simulate</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Intensity Level</label>
                        <select class="form-select" id="attackIntensity">
                            <option value="low">Low (Subtle)</option>
                            <option value="medium" selected>Medium (Moderate)</option>
                            <option value="high">High (Aggressive)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Target Clients</label>
                        <select class="form-select" id="targetClients">
                            <option value="malicious">Malicious Clients Only</option>
                            <option value="random">Random Clients</option>
                            <option value="all">All Clients</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Duration (seconds)</label>
                        <input type="number" class="form-control" id="attackDuration" value="30" min="10" max="300">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="simulateAttackBtn">
                    <i class="fas fa-bug me-1"></i>
                    Launch Attack
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let threatTimelineChart, attackTypesChart, threatHeatmapChart;
    
    // Initialize security charts
    function initializeSecurityCharts() {
        // Threat Timeline Chart
        const timelineLayout = {
            title: 'Threat Detection Over Time',
            xaxis: { title: 'Time' },
            yaxis: { title: 'Threat Level' },
            margin: { t: 40, r: 40, b: 40, l: 60 }
        };
        Plotly.newPlot('threatTimelineChart', [], timelineLayout, {responsive: true});
        
        // Attack Types Pie Chart
        const pieLayout = {
            margin: { t: 40, r: 40, b: 40, l: 40 }
        };
        Plotly.newPlot('attackTypesChart', [], pieLayout, {responsive: true});
        
        // Threat Heatmap
        const heatmapLayout = {
            title: 'Client Threat Levels',
            margin: { t: 40, r: 40, b: 40, l: 100 }
        };
        Plotly.newPlot('threatHeatmap', [], heatmapLayout, {responsive: true});
    }
    
    // Update security dashboard
    function updateDashboard(data) {
        updateSecurityMetrics(data);
        updateSecurityEvents(data);
        updateThreatTimeline(data);
        updateAttackTypesChart(data);
        updateThreatHeatmap(data);
        updateActiveAlerts(data);
    }
    
    // Update security metrics
    function updateSecurityMetrics(data) {
        const clients = data.clients || {};
        const events = data.metrics?.security_events || [];
        
        // Calculate detection rate
        const maliciousClients = Object.values(clients).filter(c => c.type === 'malicious');
        const quarantinedMalicious = maliciousClients.filter(c => c.quarantined);
        const detectionRate = maliciousClients.length > 0 ? 
            (quarantinedMalicious.length / maliciousClients.length * 100) : 100;
        
        // Calculate false positive rate
        const honestClients = Object.values(clients).filter(c => c.type === 'honest');
        const quarantinedHonest = honestClients.filter(c => c.quarantined);
        const falsePositiveRate = honestClients.length > 0 ? 
            (quarantinedHonest.length / honestClients.length * 100) : 0;
        
        // Active threats (high severity events in last 10 minutes)
        const recentEvents = events.filter(e => {
            const eventTime = new Date(e.timestamp);
            const tenMinutesAgo = new Date(Date.now() - 10 * 60 * 1000);
            return eventTime > tenMinutesAgo && e.severity === 'high';
        });
        
        // Security score (based on detection rate and false positive rate)
        const securityScore = Math.max(0, Math.min(100, 
            detectionRate - (falsePositiveRate * 2)
        ));
        
        document.getElementById('detectionRate').textContent = detectionRate.toFixed(1) + '%';
        document.getElementById('falsePositiveRate').textContent = falsePositiveRate.toFixed(1) + '%';
        document.getElementById('activeThreats').textContent = recentEvents.length;
        document.getElementById('securityScore').textContent = securityScore.toFixed(0);
    }
    
    // Update security events list
    function updateSecurityEvents(data) {
        const container = document.getElementById('securityEventsList');
        const events = data.metrics?.security_events || [];
        
        if (events.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-shield-alt fa-3x mb-3"></i>
                    <p>No security events detected</p>
                </div>
            `;
            return;
        }
        
        const eventsHtml = events.slice(-20).reverse().map(event => {
            const severityClass = {
                'high': 'danger',
                'medium': 'warning',
                'low': 'info'
            }[event.severity] || 'secondary';
            
            const icon = {
                'quarantine': 'ban',
                'high_anomaly': 'exclamation-triangle',
                'authentication_failure': 'lock',
                'crypto_error': 'key'
            }[event.event_type] || 'shield-alt';
            
            return `
                <div class="alert alert-${severityClass} alert-dismissible mb-2" data-severity="${event.severity}">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-${icon} me-3 mt-1"></i>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>${event.client_id || 'System'}</strong>
                                    <span class="badge bg-${severityClass} ms-2">${event.severity.toUpperCase()}</span>
                                </div>
                                <small class="text-muted">${formatTime(event.timestamp)}</small>
                            </div>
                            <p class="mb-1">${event.description}</p>
                            ${event.anomaly_score ? `<small>Anomaly Score: ${event.anomaly_score.toFixed(3)}</small>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = eventsHtml;
    }
    
    // Update threat timeline chart
    function updateThreatTimeline(data) {
        const events = data.metrics?.security_events || [];
        const timestamps = data.metrics?.timestamps || [];
        
        if (events.length === 0) return;
        
        // Aggregate threat levels over time
        const threatLevels = timestamps.map(timestamp => {
            const recentEvents = events.filter(e => {
                const eventTime = new Date(e.timestamp);
                const currentTime = new Date(timestamp);
                const timeDiff = Math.abs(currentTime - eventTime) / (1000 * 60); // minutes
                return timeDiff <= 5; // Events within 5 minutes
            });
            
            return recentEvents.reduce((sum, event) => {
                const severityWeight = { 'high': 3, 'medium': 2, 'low': 1 }[event.severity] || 0;
                return sum + severityWeight;
            }, 0);
        });
        
        const trace = {
            x: timestamps,
            y: threatLevels,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Threat Level',
            line: { color: 'red', width: 2 },
            fill: 'tonexty',
            fillcolor: 'rgba(255, 0, 0, 0.1)'
        };
        
        Plotly.redraw('threatTimelineChart', [trace]);
    }
    
    // Update attack types chart
    function updateAttackTypesChart(data) {
        const events = data.metrics?.security_events || [];
        
        // Count attack types
        const attackTypes = {};
        events.forEach(event => {
            const type = event.event_type || 'unknown';
            attackTypes[type] = (attackTypes[type] || 0) + 1;
        });
        
        if (Object.keys(attackTypes).length === 0) {
            document.getElementById('attackTypesChart').innerHTML = 
                '<div class="text-center text-muted py-4"><p>No attack data available</p></div>';
            return;
        }
        
        const trace = {
            type: 'pie',
            labels: Object.keys(attackTypes),
            values: Object.values(attackTypes),
            textinfo: 'label+percent',
            textposition: 'outside',
            marker: {
                colors: ['#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3', '#54a0ff']
            }
        };
        
        Plotly.redraw('attackTypesChart', [trace]);
    }
    
    // Update threat heatmap
    function updateThreatHeatmap(data) {
        const clients = data.clients || {};
        
        const clientIds = Object.keys(clients);
        const threatLevels = clientIds.map(id => {
            const client = clients[id];
            const anomalyScore = client.last_anomaly_score || 0;
            const reputation = client.reputation || 1;
            
            // Calculate threat level based on anomaly score and reputation
            return anomalyScore * (2 - reputation);
        });
        
        if (clientIds.length === 0) return;
        
        const trace = {
            type: 'heatmap',
            z: [threatLevels],
            x: clientIds,
            y: ['Threat Level'],
            colorscale: [
                [0, 'green'],
                [0.5, 'yellow'],
                [1, 'red']
            ],
            showscale: true
        };
        
        Plotly.redraw('threatHeatmap', [trace]);
    }
    
    // Update active alerts
    function updateActiveAlerts(data) {
        const container = document.getElementById('activeAlerts');
        
        // Generate mock alerts based on current system state
        const alerts = [];
        const clients = data.clients || {};
        
        Object.entries(clients).forEach(([clientId, client]) => {
            if (client.quarantined) {
                alerts.push({
                    type: 'warning',
                    title: 'Client Quarantined',
                    message: `${clientId} has been quarantined`,
                    timestamp: new Date().toISOString()
                });
            }
            
            if (client.last_anomaly_score > 0.8) {
                alerts.push({
                    type: 'danger',
                    title: 'High Anomaly Score',
                    message: `${clientId} showing suspicious behavior`,
                    timestamp: new Date().toISOString()
                });
            }
        });
        
        if (alerts.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-check-circle fa-2x mb-2 text-success"></i>
                    <p>No active alerts</p>
                </div>
            `;
            return;
        }
        
        const alertsHtml = alerts.slice(0, 5).map(alert => `
            <div class="alert alert-${alert.type} alert-sm mb-2">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>${alert.title}</strong>
                        <p class="mb-0 small">${alert.message}</p>
                    </div>
                    <button type="button" class="btn-close btn-sm"></button>
                </div>
            </div>
        `).join('');
        
        container.innerHTML = alertsHtml;
    }
    
    // Event filtering
    function setupEventFiltering() {
        document.querySelectorAll('[data-filter]').forEach(btn => {
            btn.addEventListener('click', function() {
                const filter = this.dataset.filter;
                
                // Update active button
                document.querySelectorAll('[data-filter]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // Filter events
                const events = document.querySelectorAll('[data-severity]');
                events.forEach(event => {
                    if (filter === 'all' || event.dataset.severity === filter) {
                        event.style.display = 'block';
                    } else {
                        event.style.display = 'none';
                    }
                });
            });
        });
    }
    
    // Attack simulation
    function setupAttackSimulation() {
        document.getElementById('simulateAttackBtn').addEventListener('click', function() {
            const attackType = document.getElementById('attackType').value;
            const intensity = document.getElementById('attackIntensity').value;
            const targets = document.getElementById('targetClients').value;
            const duration = document.getElementById('attackDuration').value;
            
            fetch('/api/simulate_attack', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    type: attackType, 
                    intensity: intensity,
                    targets: targets,
                    duration: parseInt(duration)
                })
            })
            .then(response => response.json())
            .then(data => {
                showToast(`Launched ${attackType} attack (${intensity} intensity)`, 'warning');
                bootstrap.Modal.getInstance(document.getElementById('attackModal')).hide();
            })
            .catch(error => {
                showToast(`Error launching attack: ${error}`, 'danger');
            });
        });
    }
    
    // Generate security report
    function generateSecurityReport() {
        const reportData = {
            timestamp: new Date().toISOString(),
            system_status: dashboardData.system_status,
            clients: dashboardData.clients,
            security_events: dashboardData.metrics?.security_events || [],
            metrics: {
                detection_rate: document.getElementById('detectionRate').textContent,
                false_positive_rate: document.getElementById('falsePositiveRate').textContent,
                active_threats: document.getElementById('activeThreats').textContent,
                security_score: document.getElementById('securityScore').textContent
            }
        };
        
        const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `qsfl-caad-security-report-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        showToast('Security report generated', 'success');
    }
    
    // Initialize security page
    document.addEventListener('DOMContentLoaded', function() {
        initializeSecurityCharts();
        setupEventFiltering();
        setupAttackSimulation();
        
        document.getElementById('generateReportBtn').addEventListener('click', generateSecurityReport);
    });
</script>
{% endblock %}