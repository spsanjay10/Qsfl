{% extends "base.html" %}

{% block title %}Analytics - QSFL-CAAD{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-chart-line me-2"></i>
        Advanced Analytics
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-primary" id="exportAnalyticsBtn">
                <i class="fas fa-download"></i> Export Data
            </button>
            <button type="button" class="btn btn-sm btn-outline-info" id="refreshAnalyticsBtn">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>
</div>

<!-- Time Range Selector -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h6 class="mb-0">Analysis Time Range</h6>
                    </div>
                    <div class="col-md-6">
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="timeRange" id="range1h" value="1h" checked>
                            <label class="btn btn-outline-primary" for="range1h">1 Hour</label>
                            
                            <input type="radio" class="btn-check" name="timeRange" id="range6h" value="6h">
                            <label class="btn btn-outline-primary" for="range6h">6 Hours</label>
                            
                            <input type="radio" class="btn-check" name="timeRange" id="range24h" value="24h">
                            <label class="btn btn-outline-primary" for="range24h">24 Hours</label>
                            
                            <input type="radio" class="btn-check" name="timeRange" id="range7d" value="7d">
                            <label class="btn btn-outline-primary" for="range7d">7 Days</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Key Performance Indicators -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="text-primary mb-2">
                    <i class="fas fa-brain fa-2x"></i>
                </div>
                <h4 id="avgAccuracy">0%</h4>
                <p class="text-muted mb-0">Average Model Accuracy</p>
                <small class="text-success" id="accuracyTrend">↗ +2.3%</small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="text-success mb-2">
                    <i class="fas fa-sync fa-2x"></i>
                </div>
                <h4 id="totalRounds">0</h4>
                <p class="text-muted mb-0">Training Rounds</p>
                <small class="text-info" id="roundsRate">2.1 rounds/min</small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="text-warning mb-2">
                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                </div>
                <h4 id="anomalyRate">0%</h4>
                <p class="text-muted mb-0">Anomaly Detection Rate</p>
                <small class="text-danger" id="anomalyTrend">↗ +0.5%</small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="text-info mb-2">
                    <i class="fas fa-network-wired fa-2x"></i>
                </div>
                <h4 id="throughput">0</h4>
                <p class="text-muted mb-0">Updates/Second</p>
                <small class="text-success" id="throughputTrend">↗ +15%</small>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Charts -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-area me-2"></i>
                    Model Performance Analysis
                </h5>
            </div>
            <div class="card-body">
                <div id="performanceAnalysisChart" style="height: 400px;"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-users me-2"></i>
                    Client Performance Distribution
                </h5>
            </div>
            <div class="card-body">
                <div id="clientDistributionChart" style="height: 400px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Analytics -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-shield-alt me-2"></i>
                    Security Metrics Correlation
                </h5>
            </div>
            <div class="card-body">
                <div id="securityCorrelationChart" style="height: 350px;"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tachometer-alt me-2"></i>
                    System Resource Utilization
                </h5>
            </div>
            <div class="card-body">
                <div id="resourceUtilizationChart" style="height: 350px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Statistical Analysis -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-calculator me-2"></i>
                    Statistical Analysis
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-4">
                        <h6>Model Accuracy Statistics</h6>
                        <table class="table table-sm">
                            <tr><td>Mean:</td><td id="accuracyMean">-</td></tr>
                            <tr><td>Median:</td><td id="accuracyMedian">-</td></tr>
                            <tr><td>Std Dev:</td><td id="accuracyStd">-</td></tr>
                            <tr><td>Min:</td><td id="accuracyMin">-</td></tr>
                            <tr><td>Max:</td><td id="accuracyMax">-</td></tr>
                        </table>
                    </div>
                    <div class="col-lg-4">
                        <h6>Anomaly Score Statistics</h6>
                        <table class="table table-sm">
                            <tr><td>Mean:</td><td id="anomalyMean">-</td></tr>
                            <tr><td>Median:</td><td id="anomalyMedian">-</td></tr>
                            <tr><td>Std Dev:</td><td id="anomalyStd">-</td></tr>
                            <tr><td>95th Percentile:</td><td id="anomaly95th">-</td></tr>
                            <tr><td>Threshold Violations:</td><td id="anomalyViolations">-</td></tr>
                        </table>
                    </div>
                    <div class="col-lg-4">
                        <h6>System Performance</h6>
                        <table class="table table-sm">
                            <tr><td>Avg Response Time:</td><td id="avgResponseTime">-</td></tr>
                            <tr><td>Peak Throughput:</td><td id="peakThroughput">-</td></tr>
                            <tr><td>Error Rate:</td><td id="errorRate">-</td></tr>
                            <tr><td>Uptime:</td><td id="systemUptime">-</td></tr>
                            <tr><td>Data Processed:</td><td id="dataProcessed">-</td></tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Predictive Analytics -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-crystal-ball me-2"></i>
                    Predictive Analytics & Forecasting
                </h5>
            </div>
            <div class="card-body">
                <div id="predictiveChart" style="height: 400px;"></div>
                <div class="row mt-3">
                    <div class="col-md-4">
                        <div class="text-center">
                            <h6>Predicted Accuracy (Next Hour)</h6>
                            <h4 class="text-primary" id="predictedAccuracy">92.5%</h4>
                            <small class="text-muted">Confidence: 85%</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <h6>Expected Anomalies</h6>
                            <h4 class="text-warning" id="expectedAnomalies">3-5</h4>
                            <small class="text-muted">Based on current trends</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <h6>System Load Forecast</h6>
                            <h4 class="text-info" id="systemLoadForecast">Medium</h4>
                            <small class="text-muted">Next 2 hours</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let performanceChart, clientDistChart, securityCorrelationChart, resourceChart, predictiveChart;
    let currentTimeRange = '1h';
    
    // Initialize analytics charts
    function initializeAnalyticsCharts() {
        // Performance Analysis Chart
        const performanceLayout = {
            title: 'Model Performance Over Time',
            xaxis: { title: 'Time' },
            yaxis: { title: 'Accuracy' },
            margin: { t: 40, r: 40, b: 40, l: 60 }
        };
        Plotly.newPlot('performanceAnalysisChart', [], performanceLayout, {responsive: true});
        
        // Client Distribution Chart
        const distLayout = {
            margin: { t: 40, r: 40, b: 40, l: 40 }
        };
        Plotly.newPlot('clientDistributionChart', [], distLayout, {responsive: true});
        
        // Security Correlation Chart
        const corrLayout = {
            title: 'Anomaly Score vs Reputation',
            xaxis: { title: 'Reputation Score' },
            yaxis: { title: 'Anomaly Score' },
            margin: { t: 40, r: 40, b: 40, l: 60 }
        };
        Plotly.newPlot('securityCorrelationChart', [], corrLayout, {responsive: true});
        
        // Resource Utilization Chart
        const resourceLayout = {
            title: 'System Resource Usage',
            xaxis: { title: 'Time' },
            yaxis: { title: 'Usage %' },
            margin: { t: 40, r: 40, b: 40, l: 60 }
        };
        Plotly.newPlot('resourceUtilizationChart', [], resourceLayout, {responsive: true});
        
        // Predictive Chart
        const predictiveLayout = {
            title: 'Predictive Model Performance Forecast',
            xaxis: { title: 'Time' },
            yaxis: { title: 'Predicted Accuracy' },
            margin: { t: 40, r: 40, b: 40, l: 60 }
        };
        Plotly.newPlot('predictiveChart', [], predictiveLayout, {responsive: true});
    }
    
    // Update analytics dashboard
    function updateDashboard(data) {
        updateKPIs(data);
        updatePerformanceAnalysis(data);
        updateClientDistribution(data);
        updateSecurityCorrelation(data);
        updateResourceUtilization(data);
        updateStatistics(data);
        updatePredictiveAnalytics(data);
    }
    
    // Update Key Performance Indicators
    function updateKPIs(data) {
        const accuracy = data.metrics?.model_accuracy || [];
        const avgAccuracy = accuracy.length > 0 ? 
            accuracy.reduce((a, b) => a + b, 0) / accuracy.length : 0;
        
        document.getElementById('avgAccuracy').textContent = (avgAccuracy * 100).toFixed(1) + '%';
        document.getElementById('totalRounds').textContent = data.current_round || 0;
        
        // Calculate anomaly rate
        const clients = data.clients || {};
        const totalClients = Object.keys(clients).length;
        const anomalousClients = Object.values(clients).filter(c => c.last_anomaly_score > 0.6).length;
        const anomalyRate = totalClients > 0 ? (anomalousClients / totalClients * 100) : 0;
        
        document.getElementById('anomalyRate').textContent = anomalyRate.toFixed(1) + '%';
        
        // Calculate throughput (mock)
        const throughput = Math.floor(Math.random() * 50) + 20;
        document.getElementById('throughput').textContent = throughput;
    }
    
    // Update performance analysis chart
    function updatePerformanceAnalysis(data) {
        const accuracy = data.metrics?.model_accuracy || [];
        const timestamps = data.metrics?.timestamps || [];
        
        if (accuracy.length === 0) return;
        
        // Historical accuracy
        const historicalTrace = {
            x: timestamps.slice(-accuracy.length),
            y: accuracy,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Historical Accuracy',
            line: { color: '#667eea', width: 2 }
        };
        
        // Moving average
        const windowSize = Math.min(5, accuracy.length);
        const movingAvg = [];
        for (let i = windowSize - 1; i < accuracy.length; i++) {
            const sum = accuracy.slice(i - windowSize + 1, i + 1).reduce((a, b) => a + b, 0);
            movingAvg.push(sum / windowSize);
        }
        
        const movingAvgTrace = {
            x: timestamps.slice(-movingAvg.length),
            y: movingAvg,
            type: 'scatter',
            mode: 'lines',
            name: 'Moving Average',
            line: { color: '#ff6b6b', width: 3, dash: 'dash' }
        };
        
        Plotly.redraw('performanceAnalysisChart', [historicalTrace, movingAvgTrace]);
    }
    
    // Update client distribution chart
    function updateClientDistribution(data) {
        const clients = data.clients || {};
        
        // Count clients by type
        const distribution = {};
        Object.values(clients).forEach(client => {
            distribution[client.type] = (distribution[client.type] || 0) + 1;
        });
        
        if (Object.keys(distribution).length === 0) return;
        
        const trace = {
            type: 'pie',
            labels: Object.keys(distribution),
            values: Object.values(distribution),
            textinfo: 'label+percent',
            marker: {
                colors: ['#28a745', '#ffc107', '#dc3545']
            }
        };
        
        Plotly.redraw('clientDistributionChart', [trace]);
    }
    
    // Update security correlation chart
    function updateSecurityCorrelation(data) {
        const clients = data.clients || {};
        
        const reputations = [];
        const anomalyScores = [];
        const clientTypes = [];
        const clientIds = [];
        
        Object.entries(clients).forEach(([id, client]) => {
            reputations.push(client.reputation);
            anomalyScores.push(client.last_anomaly_score);
            clientTypes.push(client.type);
            clientIds.push(id);
        });
        
        if (reputations.length === 0) return;
        
        const trace = {
            x: reputations,
            y: anomalyScores,
            mode: 'markers',
            type: 'scatter',
            text: clientIds,
            marker: {
                size: 10,
                color: clientTypes.map(type => 
                    type === 'honest' ? 'green' : 
                    type === 'suspicious' ? 'orange' : 'red'
                ),
                opacity: 0.7
            },
            name: 'Clients'
        };
        
        Plotly.redraw('securityCorrelationChart', [trace]);
    }
    
    // Update resource utilization chart
    function updateResourceUtilization(data) {
        const performance = data.metrics?.system_performance || [];
        const timestamps = data.metrics?.timestamps || [];
        
        if (performance.length === 0) return;
        
        const cpuTrace = {
            x: timestamps.slice(-performance.length),
            y: performance.map(p => p.cpu_usage || 0),
            type: 'scatter',
            mode: 'lines',
            name: 'CPU Usage',
            line: { color: '#ff6b6b' }
        };
        
        const memoryTrace = {
            x: timestamps.slice(-performance.length),
            y: performance.map(p => p.memory_usage || 0),
            type: 'scatter',
            mode: 'lines',
            name: 'Memory Usage',
            line: { color: '#4ecdc4' }
        };
        
        const networkTrace = {
            x: timestamps.slice(-performance.length),
            y: performance.map(p => p.network_io || 0),
            type: 'scatter',
            mode: 'lines',
            name: 'Network I/O',
            line: { color: '#45b7d1' }
        };
        
        Plotly.redraw('resourceUtilizationChart', [cpuTrace, memoryTrace, networkTrace]);
    }
    
    // Update statistics
    function updateStatistics(data) {
        const accuracy = data.metrics?.model_accuracy || [];
        
        if (accuracy.length > 0) {
            const sorted = [...accuracy].sort((a, b) => a - b);
            const mean = accuracy.reduce((a, b) => a + b, 0) / accuracy.length;
            const median = sorted[Math.floor(sorted.length / 2)];
            const variance = accuracy.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / accuracy.length;
            const stdDev = Math.sqrt(variance);
            
            document.getElementById('accuracyMean').textContent = (mean * 100).toFixed(2) + '%';
            document.getElementById('accuracyMedian').textContent = (median * 100).toFixed(2) + '%';
            document.getElementById('accuracyStd').textContent = (stdDev * 100).toFixed(2) + '%';
            document.getElementById('accuracyMin').textContent = (Math.min(...accuracy) * 100).toFixed(2) + '%';
            document.getElementById('accuracyMax').textContent = (Math.max(...accuracy) * 100).toFixed(2) + '%';
        }
        
        // Anomaly statistics
        const clients = data.clients || {};
        const anomalyScores = Object.values(clients).map(c => c.last_anomaly_score);
        
        if (anomalyScores.length > 0) {
            const sortedAnomalies = [...anomalyScores].sort((a, b) => a - b);
            const anomalyMean = anomalyScores.reduce((a, b) => a + b, 0) / anomalyScores.length;
            const anomalyMedian = sortedAnomalies[Math.floor(sortedAnomalies.length / 2)];
            const anomalyVariance = anomalyScores.reduce((sum, val) => sum + Math.pow(val - anomalyMean, 2), 0) / anomalyScores.length;
            const anomalyStd = Math.sqrt(anomalyVariance);
            const percentile95 = sortedAnomalies[Math.floor(sortedAnomalies.length * 0.95)];
            const violations = anomalyScores.filter(score => score > 0.6).length;
            
            document.getElementById('anomalyMean').textContent = anomalyMean.toFixed(3);
            document.getElementById('anomalyMedian').textContent = anomalyMedian.toFixed(3);
            document.getElementById('anomalyStd').textContent = anomalyStd.toFixed(3);
            document.getElementById('anomaly95th').textContent = percentile95.toFixed(3);
            document.getElementById('anomalyViolations').textContent = violations;
        }
        
        // System performance statistics (mock data)
        document.getElementById('avgResponseTime').textContent = '45ms';
        document.getElementById('peakThroughput').textContent = '1,250 ops/sec';
        document.getElementById('errorRate').textContent = '0.02%';
        document.getElementById('systemUptime').textContent = '99.97%';
        document.getElementById('dataProcessed').textContent = '2.3 GB';
    }
    
    // Update predictive analytics
    function updatePredictiveAnalytics(data) {
        const accuracy = data.metrics?.model_accuracy || [];
        
        if (accuracy.length < 5) return;
        
        // Simple linear regression for prediction
        const recent = accuracy.slice(-10);
        const x = recent.map((_, i) => i);
        const y = recent;
        
        // Calculate trend
        const n = recent.length;
        const sumX = x.reduce((a, b) => a + b, 0);
        const sumY = y.reduce((a, b) => a + b, 0);
        const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
        const sumXX = x.reduce((sum, xi) => sum + xi * xi, 0);
        
        const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
        const intercept = (sumY - slope * sumX) / n;
        
        // Generate predictions
        const futurePoints = 10;
        const predictions = [];
        const predictionTimes = [];
        
        for (let i = 0; i < futurePoints; i++) {
            const futureX = recent.length + i;
            const prediction = slope * futureX + intercept;
            predictions.push(Math.max(0, Math.min(1, prediction)));
            
            // Generate future timestamps
            const lastTime = new Date(data.metrics?.timestamps?.slice(-1)[0] || Date.now());
            const futureTime = new Date(lastTime.getTime() + (i + 1) * 2 * 60 * 1000); // 2 minutes intervals
            predictionTimes.push(futureTime.toISOString());
        }
        
        // Historical trace
        const historicalTrace = {
            x: data.metrics?.timestamps?.slice(-accuracy.length) || [],
            y: accuracy,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Historical',
            line: { color: '#667eea' }
        };
        
        // Prediction trace
        const predictionTrace = {
            x: predictionTimes,
            y: predictions,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Predicted',
            line: { color: '#ff6b6b', dash: 'dash' }
        };
        
        Plotly.redraw('predictiveChart', [historicalTrace, predictionTrace]);
        
        // Update prediction values
        const nextHourPrediction = predictions[Math.min(29, predictions.length - 1)]; // ~1 hour ahead
        document.getElementById('predictedAccuracy').textContent = (nextHourPrediction * 100).toFixed(1) + '%';
    }
    
    // Time range change handler
    function setupTimeRangeSelector() {
        document.querySelectorAll('input[name="timeRange"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    currentTimeRange = this.value;
                    // Trigger data refresh with new time range
                    socket.emit('request_update');
                    showToast(`Time range changed to ${this.value}`, 'info');
                }
            });
        });
    }
    
    // Export analytics data
    function exportAnalyticsData() {
        const analyticsData = {
            timestamp: new Date().toISOString(),
            time_range: currentTimeRange,
            dashboard_data: dashboardData,
            statistics: {
                accuracy: {
                    mean: document.getElementById('accuracyMean').textContent,
                    median: document.getElementById('accuracyMedian').textContent,
                    std: document.getElementById('accuracyStd').textContent,
                    min: document.getElementById('accuracyMin').textContent,
                    max: document.getElementById('accuracyMax').textContent
                },
                anomaly: {
                    mean: document.getElementById('anomalyMean').textContent,
                    median: document.getElementById('anomalyMedian').textContent,
                    std: document.getElementById('anomalyStd').textContent,
                    percentile_95: document.getElementById('anomaly95th').textContent,
                    violations: document.getElementById('anomalyViolations').textContent
                }
            }
        };
        
        const blob = new Blob([JSON.stringify(analyticsData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `qsfl-caad-analytics-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        showToast('Analytics data exported', 'success');
    }
    
    // Initialize analytics page
    document.addEventListener('DOMContentLoaded', function() {
        initializeAnalyticsCharts();
        setupTimeRangeSelector();
        
        document.getElementById('exportAnalyticsBtn').addEventListener('click', exportAnalyticsData);
        document.getElementById('refreshAnalyticsBtn').addEventListener('click', () => {
            socket.emit('request_update');
            showToast('Analytics refreshed', 'info');
        });
    });
</script>
{% endblock %}