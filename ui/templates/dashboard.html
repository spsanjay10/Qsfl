{% extends "base.html" %}

{% block title %}Dashboard - QSFL-CAAD{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-tachometer-alt me-2"></i>
        System Dashboard
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="refreshBtn">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="exportBtn">
                <i class="fas fa-download"></i> Export
            </button>
        </div>
    </div>
</div>

<!-- System Status Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card metric-card">
            <div class="card-body">
                <div class="metric-value" id="systemStatus">STOPPED</div>
                <div class="metric-label">
                    <span class="status-indicator" id="statusIndicator"></span>
                    System Status
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card metric-card">
            <div class="card-body">
                <div class="metric-value" id="currentRound">0</div>
                <div class="metric-label">
                    <i class="fas fa-sync me-1"></i>
                    Training Round
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card metric-card">
            <div class="card-body">
                <div class="metric-value" id="activeClients">0</div>
                <div class="metric-label">
                    <i class="fas fa-users me-1"></i>
                    Active Clients
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card metric-card">
            <div class="card-body">
                <div class="metric-value" id="modelAccuracy">0%</div>
                <div class="metric-label">
                    <i class="fas fa-brain me-1"></i>
                    Model Accuracy
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Real-time Charts -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    Real-time Anomaly Detection
                </h5>
            </div>
            <div class="card-body">
                <div id="anomalyChart" style="height: 400px;"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-globe me-2"></i>
                    Client Distribution
                </h5>
            </div>
            <div class="card-body">
                <div id="worldMap" style="height: 400px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Model Performance and Security Events -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-area me-2"></i>
                    Model Performance
                </h5>
            </div>
            <div class="card-body">
                <div id="performanceChart" style="height: 300px;"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-shield-alt me-2"></i>
                    Recent Security Events
                </h5>
            </div>
            <div class="card-body" style="height: 300px; overflow-y: auto;">
                <div id="securityEvents">
                    <div class="text-center text-muted">
                        <i class="fas fa-shield-alt fa-2x mb-2"></i>
                        <p>No security events</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Client Overview -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-users me-2"></i>
                    Client Overview
                </h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" id="filterAll">All</button>
                    <button class="btn btn-outline-success" id="filterHonest">Honest</button>
                    <button class="btn btn-outline-warning" id="filterSuspicious">Suspicious</button>
                    <button class="btn btn-outline-danger" id="filterMalicious">Malicious</button>
                </div>
            </div>
            <div class="card-body">
                <div class="row" id="clientCards">
                    <!-- Client cards will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Attack Simulation Modal -->
<div class="modal fade" id="attackModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-bug me-2"></i>
                    Simulate Attack
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="attackForm">
                    <div class="mb-3">
                        <label class="form-label">Attack Type</label>
                        <select class="form-select" id="attackType">
                            <option value="gradient_poisoning">Gradient Poisoning</option>
                            <option value="label_flipping">Label Flipping</option>
                            <option value="backdoor">Backdoor Attack</option>
                            <option value="model_replacement">Model Replacement</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Intensity</label>
                        <select class="form-select" id="attackIntensity">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="simulateAttackBtn">
                    <i class="fas fa-bug me-1"></i>
                    Simulate Attack
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Dashboard-specific variables
    let anomalyChart, performanceChart, worldMapChart;
    
    // Initialize charts
    function initializeCharts() {
        // Anomaly Detection Chart
        const anomalyLayout = {
            title: 'Client Anomaly Scores Over Time',
            xaxis: { title: 'Time' },
            yaxis: { title: 'Anomaly Score', range: [0, 1] },
            showlegend: true,
            margin: { t: 40, r: 40, b: 40, l: 60 }
        };
        
        Plotly.newPlot('anomalyChart', [], anomalyLayout, {responsive: true});
        
        // Performance Chart
        const performanceLayout = {
            title: 'Model Accuracy Trend',
            xaxis: { title: 'Training Round' },
            yaxis: { title: 'Accuracy', range: [0, 1] },
            margin: { t: 40, r: 40, b: 40, l: 60 }
        };
        
        Plotly.newPlot('performanceChart', [], performanceLayout, {responsive: true});
        
        // World Map
        const mapLayout = {
            geo: {
                projection: { type: 'natural earth' },
                showland: true,
                landcolor: 'rgb(243, 243, 243)',
                coastlinecolor: 'rgb(204, 204, 204)',
            },
            margin: { t: 0, r: 0, b: 0, l: 0 }
        };
        
        Plotly.newPlot('worldMap', [], mapLayout, {responsive: true});
    }
    
    // Update dashboard with new data
    function updateDashboard(data) {
        updateStatusCards(data);
        updateAnomalyChart(data);
        updatePerformanceChart(data);
        updateWorldMap(data);
        updateSecurityEvents(data);
        updateClientCards(data);
    }
    
    // Update status cards
    function updateStatusCards(data) {
        const status = data.system_status || 'stopped';
        document.getElementById('systemStatus').textContent = status.toUpperCase();
        document.getElementById('currentRound').textContent = data.current_round || 0;
        
        const activeClients = Object.values(data.clients || {}).filter(c => 
            c.status === 'active' && !c.quarantined
        ).length;
        document.getElementById('activeClients').textContent = activeClients;
        
        const accuracy = data.metrics?.model_accuracy?.slice(-1)[0] || 0;
        document.getElementById('modelAccuracy').textContent = (accuracy * 100).toFixed(1) + '%';
        
        // Update status indicator
        const indicator = document.getElementById('statusIndicator');
        indicator.className = `status-indicator status-${status}`;
    }
    
    // Update anomaly chart
    function updateAnomalyChart(data) {
        if (!data.metrics?.anomaly_scores) return;
        
        const traces = [];
        const timestamps = data.metrics.timestamps || [];
        
        // Add threshold line
        traces.push({
            x: timestamps,
            y: Array(timestamps.length).fill(0.6),
            name: 'Threshold',
            type: 'scatter',
            mode: 'lines',
            line: { color: 'red', dash: 'dash' }
        });
        
        // Add client traces
        Object.entries(data.metrics.anomaly_scores).forEach(([clientId, scores]) => {
            if (scores.length > 0) {
                const client = data.clients[clientId] || {};
                const color = client.type === 'malicious' ? 'red' : 
                             client.type === 'suspicious' ? 'orange' : 'blue';
                
                traces.push({
                    x: timestamps.slice(-scores.length),
                    y: scores,
                    name: clientId,
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { color: color },
                    opacity: client.quarantined ? 0.5 : 1.0
                });
            }
        });
        
        Plotly.redraw('anomalyChart', traces);
    }
    
    // Update performance chart
    function updatePerformanceChart(data) {
        if (!data.metrics?.model_accuracy) return;
        
        const accuracy = data.metrics.model_accuracy;
        const rounds = Array.from({length: accuracy.length}, (_, i) => i + 1);
        
        const trace = {
            x: rounds,
            y: accuracy,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Model Accuracy',
            line: { color: 'green', width: 3 }
        };
        
        Plotly.redraw('performanceChart', [trace]);
    }
    
    // Update world map
    function updateWorldMap(data) {
        fetch('/api/world_map_data')
            .then(response => response.json())
            .then(mapData => {
                const trace = {
                    type: 'scattergeo',
                    mode: 'markers',
                    lat: mapData.map(d => d.lat),
                    lon: mapData.map(d => d.lng),
                    text: mapData.map(d => 
                        `${d.client_id}<br>${d.city}, ${d.country}<br>` +
                        `Type: ${d.type}<br>Status: ${d.status}<br>` +
                        `Reputation: ${d.reputation.toFixed(3)}`
                    ),
                    marker: {
                        size: mapData.map(d => d.reputation * 20 + 5),
                        color: mapData.map(d => 
                            d.status === 'quarantined' ? 'red' :
                            d.type === 'malicious' ? 'orange' :
                            d.type === 'suspicious' ? 'yellow' : 'green'
                        ),
                        opacity: 0.8,
                        line: { color: 'white', width: 1 }
                    }
                };
                
                Plotly.redraw('worldMap', [trace]);
            });
    }
    
    // Update security events
    function updateSecurityEvents(data) {
        const container = document.getElementById('securityEvents');
        const events = data.metrics?.security_events || [];
        
        if (events.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-shield-alt fa-2x mb-2"></i>
                    <p>No security events</p>
                </div>
            `;
            return;
        }
        
        const eventsHtml = events.slice(-10).reverse().map(event => {
            const severityClass = event.severity === 'high' ? 'danger' : 'warning';
            const icon = event.event_type === 'quarantine' ? 'ban' : 'exclamation-triangle';
            
            return `
                <div class="alert alert-${severityClass} alert-custom mb-2">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-${icon} me-2"></i>
                        <div class="flex-grow-1">
                            <strong>${event.client_id}</strong>
                            <small class="text-muted d-block">${formatTime(event.timestamp)}</small>
                        </div>
                        <span class="badge bg-${severityClass}">${event.anomaly_score?.toFixed(3) || 'N/A'}</span>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = eventsHtml;
    }
    
    // Update client cards
    function updateClientCards(data) {
        const container = document.getElementById('clientCards');
        const clients = data.clients || {};
        
        const cardsHtml = Object.entries(clients).map(([clientId, client]) => {
            const typeClass = client.type;
            const statusIcon = client.quarantined ? 'ban' : 'check-circle';
            const statusColor = client.quarantined ? 'danger' : 'success';
            
            return `
                <div class="col-lg-4 col-md-6 mb-3 client-filter-item" data-type="${client.type}">
                    <div class="card client-card ${typeClass} ${client.quarantined ? 'quarantined' : ''}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-0">${clientId}</h6>
                                <i class="fas fa-${statusIcon} text-${statusColor}"></i>
                            </div>
                            <div class="row text-center">
                                <div class="col-4">
                                    <small class="text-muted">Reputation</small>
                                    <div class="fw-bold">${client.reputation.toFixed(3)}</div>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted">Anomaly</small>
                                    <div class="fw-bold">${client.last_anomaly_score.toFixed(3)}</div>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted">Updates</small>
                                    <div class="fw-bold">${client.updates_sent}</div>
                                </div>
                            </div>
                            <div class="mt-2">
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar bg-${client.reputation > 0.8 ? 'success' : client.reputation > 0.5 ? 'warning' : 'danger'}" 
                                         style="width: ${client.reputation * 100}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = cardsHtml;
    }
    
    // Client filtering
    function setupClientFiltering() {
        document.getElementById('filterAll').addEventListener('click', () => filterClients('all'));
        document.getElementById('filterHonest').addEventListener('click', () => filterClients('honest'));
        document.getElementById('filterSuspicious').addEventListener('click', () => filterClients('suspicious'));
        document.getElementById('filterMalicious').addEventListener('click', () => filterClients('malicious'));
    }
    
    function filterClients(type) {
        const items = document.querySelectorAll('.client-filter-item');
        items.forEach(item => {
            if (type === 'all' || item.dataset.type === type) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
        
        // Update active filter button
        document.querySelectorAll('#clientCards').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`filter${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.add('active');
    }
    
    // Attack simulation
    function setupAttackSimulation() {
        document.getElementById('simulateAttackBtn').addEventListener('click', () => {
            const attackType = document.getElementById('attackType').value;
            const intensity = document.getElementById('attackIntensity').value;
            
            fetch('/api/simulate_attack', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: attackType, intensity: intensity })
            })
            .then(response => response.json())
            .then(data => {
                showToast(`Simulated ${attackType} attack (${intensity})`, 'warning');
                bootstrap.Modal.getInstance(document.getElementById('attackModal')).hide();
            })
            .catch(error => {
                showToast(`Error simulating attack: ${error}`, 'danger');
            });
        });
    }
    
    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        initializeCharts();
        setupClientFiltering();
        setupAttackSimulation();
        
        // Add attack simulation button to toolbar
        const toolbar = document.querySelector('.btn-toolbar');
        const attackBtn = document.createElement('button');
        attackBtn.className = 'btn btn-sm btn-outline-danger ms-2';
        attackBtn.innerHTML = '<i class="fas fa-bug"></i> Simulate Attack';
        attackBtn.setAttribute('data-bs-toggle', 'modal');
        attackBtn.setAttribute('data-bs-target', '#attackModal');
        toolbar.appendChild(attackBtn);
        
        // Refresh button
        document.getElementById('refreshBtn').addEventListener('click', () => {
            socket.emit('request_update');
            showToast('Dashboard refreshed', 'info');
        });
        
        // Export button
        document.getElementById('exportBtn').addEventListener('click', () => {
            const data = JSON.stringify(dashboardData, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `qsfl-caad-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Data exported', 'success');
        });
    });
</script>
{% endblock %}